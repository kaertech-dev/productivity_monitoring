<!-- Dropdown to choose time period -->
<div>
    <div class="d-flex align-items-center gap-2 mb-2 justify-content-end position-relative" style="height: auto">
    <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle" type="button" id="arrowDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        </button>
        <!--dropdown forms-->
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="arrowDropdown">
            <li><a class="dropdown-item" href="#" data-target="#dayform">Day</a></li>
            <li><a class="dropdown-item" href="#" data-target="#weekform">Week</a></li>
            <li><a class="dropdown-item" href="#" data-target="#monthform">Month</a></li>
            <li><a class="dropdown-item" href="#" data-target="#rangeform">Range</a></li>
        </ul>
    </div>
    <div id="form-container" style="position: absolute; width: max-content; display: none; background: none; margin-top: 0.5rem; top: 45px; right: 160px;">
        <!--week form-->
        <form id="weekform" style="display: none;">
            <label for="week">Select week:</label>
            <input type="week" id="week" name="week" required>
            <button type="submit" style="border-style: solid; border-width: 1px; border-color: #ccc;">Submit</button>
        </form>

        <!--month form-->
        <form id="monthform" style="display: none;">
            <label for="month">Select month:</label>
            <input type="month" id="month" name="month" required>
            <button type="submit" style="border-style: solid; border-width: 1px; border-color: #ccc;">Submit</button>
        </form>

        <!--day form-->
        <form id="dayform" style="display: none;">
            <label for="day" style="font-weight: bold;">Select day:</label>
            <input type="date" id="day" name="day" required>
            <button type="submit" style="border-style: solid; border-width: 1px; border-color: #ccc;">Submit</button>
        </form>

        <!--range date-->
        <form id="rangeform">
            <label>Start Date: 
                <input type="date" class="action-start" name="start_date" value="{{ current_date.split(' → ')[0] }}">
            </label>
            <label>End Date: 
                <input type="date" class="action-end" name="end_date" value="{{ current_date.split(' → ')[1] if '→' in current_date else current_date }}">
            </label>
            <button type="submit" class="action-btn filter-btn" style="border-style: solid; border-width: 1px; border-color: #ccc;">Filter</button>
        </form>
    </div>
    <div id="spinner" class="spinner-border text-primary" role="status" style="display: none;">
        <span class="visually-hidden">loading...</span>
    </div>
</div>

<form id="filter-form" method="get">
    <div class="d-flex justify-content-between align-items-center mb-3" style="flex-wrap: wrap; gap: 1rem;">
        <!-- Dropdowns -->
        <div class="d-flex gap-2 flex-wrap">
        <!-- Customer -->
        <label for="customer">Customer:</label>
        <select id="customer" name="customer">
            <option value="" selected>All Customers</option>
            {% for val in databases %}
            <option value="{{ val }}" {% if selected_db == val %}selected{% endif %}>{{ val }}</option>
            {% endfor %}
        </select>

        <!-- Model -->
        <label for="model">Model:</label>
        <select id="model" name="model">
            <option value="" selected>All Models</option>
        </select>

        <!-- Station -->
        <label for="station">Station:</label>
        <select id="station" name="station">
            <option value="" selected>All Stations</option>
        </select>

        <button type="submit" id="filterSubmit" class="btn btn-primary">Submit</button>
        </div>

        <!-- Download Button -->
        <div>
        <a href="/download-csv" class="btn btn-success">
            ⬇️ Download CSV
        </a>
        </div>
    </div>
</form>

<script>
document.addEventListener("DOMContentLoaded", function () {
const formContainer = document.getElementById("form-container");
const dropdownItems = document.querySelectorAll(".dropdown-item");

// Show the selected form
dropdownItems.forEach(item => {
    item.addEventListener("click", function (e) {
    e.preventDefault();
    const targetId = this.getAttribute("data-target");
    const forms = formContainer.querySelectorAll("form");
    forms.forEach(form => form.style.display = "none");
    document.querySelector(targetId).style.display = "block";
    formContainer.style.display = "block";
    });
});

// Attach submit handlers to each form
const forms = formContainer.querySelectorAll("form");
forms.forEach(form => {
    form.addEventListener("submit", function (e) {
    e.preventDefault();

    let query = "";

    if (form.id === "dayform") {
        const day = form.querySelector("#day").value;
        query = `?day=${encodeURIComponent(day)}`;
    } else if (form.id === "weekform") {
        const week = form.querySelector("#week").value;
        query = `?week=${encodeURIComponent(week)}`;
    } else if (form.id === "monthform") {
        const month = form.querySelector("#month").value;
        query = `?month=${encodeURIComponent(month)}`;
    } else if (form.id === "rangeform") {
        const start = form.querySelector(".action-start").value;
        const end = form.querySelector(".action-end").value;
        query = `?start_date=${encodeURIComponent(start)}&end_date=${encodeURIComponent(end)}`;
    }

    window.location.href = `/${query}`;
    });
});
});
</script>