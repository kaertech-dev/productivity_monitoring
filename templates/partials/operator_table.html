<!--APP/app/templates/partials/operator_table.html-->
<link rel="stylesheet" href="/static/css/operator_table.css">
<div class="enhanced-table-container" role="region" style="max-height: 1000px; overflow-y: auto;">
    <table class="enhanced-table table table-striped table-hover text-center align-middle">
        <thead class="table-success">
            <tr>
                {% for col in columns %}
                    <th>{{ col }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for operator, records in groups.items() %}
            {% for record in records %}
                {% set is_last_in_group = loop.last %}
                {% set row_index = loop.index %}
                <tr class="{% if loop.first %}border-top border-5 border-dark{% endif %}">
                    {% if loop.first %}
                        <td class="border-bottom border-5" style="border-bottom-color: #000000 !important;" rowspan="{{ records|length }}">{{ record.operator_en }}</td>
                    {% endif %}
                    
                    <!-- Customer column with rowspan -->
                    {% if record.Customer_rowspan > 0 %}
                        {% set customer_spans_to_end = (row_index + record.Customer_rowspan - 1) == records|length %}
                        <td rowspan="{{ record.Customer_rowspan }}" 
                            class="{% if customer_spans_to_end %}border-bottom border-5{% endif %}"
                            style="{% if customer_spans_to_end %}border-bottom-color: #000000 !important;{% endif %}">
                            {{ record.Customer }}
                        </td>
                    {% endif %}

                    <!-- Model column with rowspan -->
                    {% if record.Model_rowspan > 0 %}
                        {% set model_spans_to_end = (row_index + record.Model_rowspan - 1) == records|length %}
                        <td rowspan="{{ record.Model_rowspan }}"
                            class="{% if model_spans_to_end %}border-bottom border-5{% endif %}"
                            style="{% if model_spans_to_end %}border-bottom-color: #000000 !important;{% endif %}">
                            {{ record.Model }}
                        </td>
                    {% endif %}
                    
                    <td class="{% if is_last_in_group %}border-bottom border-5{% endif %}" style="{% if is_last_in_group %}border-bottom-color: #000000 !important;{% endif %}">{{ record.Station }}</td>
                    <td class="{% if is_last_in_group %}border-bottom border-5{% endif %}" style="{% if is_last_in_group %}border-bottom-color: #000000 !important;{% endif %}">{{ record.Output }}</td>
                    <td class="{% if is_last_in_group %}border-bottom border-5{% endif %}" style="{% if is_last_in_group %}border-bottom-color: #000000 !important;{% endif %}">{{ record.Target_Time }}</td>
                    <td class="{% if is_last_in_group %}border-bottom border-5{% endif %}" style="{% if is_last_in_group %}border-bottom-color: #000000 !important;{% endif %}">{{ record.Cycle_Time }}</td>
                    <td class="{% if is_last_in_group %}border-bottom border-5{% endif %}" style="{% if is_last_in_group %}border-bottom-color: #000000 !important;{% endif %}">{{ record.Start_Time }}</td>
                    <td class="{% if is_last_in_group %}border-bottom border-5{% endif %}" style="{% if is_last_in_group %}border-bottom-color: #000000 !important;{% endif %}">{{ record.End_time }}</td>
                    <td class="{% if is_last_in_group %}border-bottom border-5{% endif %}" style="{% if is_last_in_group %}border-bottom-color: #000000 !important;{% endif %}">{{ record['%UTIL'] }}</td>
                    
                    {% if loop.first %}
                        <td class="border-bottom border-5" style="border-bottom-color: #000000 !important;" rowspan="{{ records|length }}">{{ summaries.get(operator, {}).get("%UTIL", 0) }}</td>
                    {% endif %}
                </tr>
            {% endfor %}
            {% endfor %}
            
            {% if summaries.get("__AVERAGE__") %}
            <tr class="table-secondary fw-bold">
                <td colspan="10" style="text-align:right;">Average Productivity Today</td>
                <td>{{ summaries["__AVERAGE__"]["%UTIL"] }}</td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>